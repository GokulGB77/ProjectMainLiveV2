<%- include('../layouts/header.ejs',{userId:userId}) %>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nouislider/14.6.3/nouislider.min.css" />

    <div class="breadcrumb-area bg-gray-4 breadcrumb-padding-1">
        <div class="container">
            <div class="breadcrumb-content text-center">
                <h2 data-aos="fade-up" data-aos-delay="200">Shop</h2>
                <ul data-aos="fade-up" data-aos-delay="400">
                    <li><a href="index">Home</a></li>
                
                    <li><i class="ti-angle-right"></i></li>
                    <li>Shop Standard </li>
                </ul>
            </div>
        </div>
        <div class="breadcrumb-img-1" data-aos="fade-right" data-aos-delay="200">
            <img src="/user/images/banner/breadcrumb-1.png" alt="">
        </div>
        <div class="breadcrumb-img-2" data-aos="fade-left" data-aos-delay="200">
            <img src="/user/images/banner/breadcrumb-2.png" alt="">
        </div>
    </div>
    <div class="shop-area pt-100 pb-100">
        <div class="container">
            <div class="row">
                <!-- update product divs class to col-lg-9 when adding the template  -->
                <!-- <div class="col-lg-3">
                    <div class="sidebar">
                        <div class="sidebar-wrapper">
                            <div class="sidebar-widget mb-40" data-aos="fade-up" data-aos-delay="200">
                                <div class="search-wrap-2">
                                    <form class="search-2-form" action="#">
                                        <input placeholder="Search*" type="text">
                                        <button class="button-search"><i class=" ti-search "></i></button>
                                    </form>
                                </div>
                            </div>
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-30">
                                    <h3>Filter By Price</h3>
                                </div>
                                <div class="price-filter">
                                    <div id="slider-range"></div>
                                    <div class="price-slider-amount">
                                        <div class="label-input">
                                            <label>Price:</label>
                                            <input type="text" id="amount" name="price" placeholder="Add Your Price" />
                                        </div>
                                        <button type="button">Filter</button>
                                    </div>
                                </div>
                            </div>
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>Product Categories</h3>
                                </div>
                                <div class="sidebar-list-style">
                                    <ul>
                                        <li><a href="shop.html">Accessories <span>4</span></a></li>
                                        <li><a href="shop.html">Book <span>9</span></a></li>
                                        <li><a href="shop.html">Clothing <span>5</span></a></li>
                                        <li><a href="shop.html">Homelife <span>3</span></a></li>
                                        <li><a href="shop.html">Kids & Baby <span>4</span></a></li>
                                        <li><a href="shop.html">Stationery <span>8</span></a></li>
                                        <li><a href="shop.html">Health & Beauty <span>3</span></a></li>
                                        <li><a href="shop.html">Home Appliances <span>4</span></a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>Choose Colour</h3>
                                </div>
                                <div class="sidebar-widget-color sidebar-list-style">
                                    <ul>
                                        <li><a class="black" href="#">Black <span>4</span></a></li>
                                        <li><a class="blue" href="#">Blue <span>9</span></a></li>
                                        <li><a class="brown" href="#">Brown <span>5</span></a></li>
                                        <li><a class="red" href="#">Red <span>3</span></a></li>
                                        <li><a class="orange" href="#">Orange <span>4</span></a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="sidebar-widget sidebar-widget-border mb-40 pb-35" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>Size</h3>
                                </div>
                                <div class="sidebar-widget-size sidebar-list-style">
                                    <ul>
                                        <li><a href="#">XL <span>4</span></a></li>
                                        <li><a href="#">M <span>9</span></a></li>
                                        <li><a href="#">LM <span>5</span></a></li>
                                        <li><a href="#">L <span>3</span></a></li>
                                        <li><a href="#">ML <span>4</span></a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="sidebar-widget" data-aos="fade-up" data-aos-delay="200">
                                <div class="sidebar-widget-title mb-25">
                                    <h3>Tags</h3>
                                </div>
                                <div class="sidebar-widget-tag">
                                    <a href="#">All, </a>
                                    <a href="#">Clothing, </a>
                                    <a href="#"> Kids, </a>
                                    <a href="#">Accessories, </a>
                                    <a href="#">Stationery, </a>
                                    <a href="#">Homelife, </a>
                                    <a href="#">Appliances, </a>
                                    <a href="#">Clothing, </a>
                                    <a href="#">Baby, </a>
                                    <a href="#">Beauty </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> -->
                <div class="col-lg-3">
                    <!-- Sidebar for sorting and filtering options -->

                    <!-- Sidebar for sorting and filtering options -->
                    <div class="sidebar">
                        <!-- <h3>Sort By</h3>
                        <ul>
                            <li><a href="/shop?page=1&sortBy=default">Default Sorting</a></li>
                            <li><a href="/shop?page=1&sortBy=A-Z">Sort by A-Z</a></li>
                            <li><a href="/shop?page=1&sortBy=Z-A">Sort by Z-A</a></li>
                            <li><a href="/shop?page=1&sortBy=Price high to low">Price high to low</a></li>
                            <li><a href="/shop?page=1&sortBy=Price low to high">Price low to high</a></li>
                            <li><a href="/shop?page=1&sortBy=latest">Sort by latest</a></li>
                        </ul>
                        <br>
                        <br> -->
                        <h4 class="text-center">Filter By </h4>
                        <!-- For category filters -->
                        <ul class="checkbox-list">
                            <h6 class="text-left">Category </h6>
                            <% allCategories.forEach(category=> { %>
                                <li class="checkbox-container">
                                    <input type="checkbox" id="<%= category._id %>" name="category"
                                        value="<%= category._id %>" <% if (filterByCategories &&
                                        filterByCategories.includes(category._id.toString())) { %> checked <% } %>>
                                        <label for="<%= category._id %>">
                                            <%= category.categoryName %>
                                        </label>
                                </li>
                                <% }) %>
                                    <hr>
                                    <h6 class="text-left">Stock </h6>
                                    <!-- For the "Out Of Stock" filter -->
                                    <li class="checkbox-container">
                                        <input type="checkbox" id="outofstock" name="outofstock" value="true" <% if
                                            (filterByOutOfStock) { %> checked <% } %>>
                                            <label for="outofstock"> Exclude Out Of Stock </label>
                                    </li>
                                    <hr>

                                    <!-- <h6 class="text-left">Price</h6>
                                    <div class="box border-bottom">

                                        <div class="" id="price">
                                            <div class="middle">
                                                <div class="multi-range-slider">
                                                    <input type="range" id="input-left" min="0" max="20000"
                                                        value="1000">
                                                    <input type="range" id="input-right" min="0" max="20000"
                                                        value="20000">
                                                    <div class="slider">
                                                        <div class="track"></div>
                                                        <div class="range"></div>
                                                        <div class="thumb left"></div>
                                                        <div class="thumb right"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center justify-content-between mt-2">
                                                <div> ₹ <span id="amount-left" class=""></span></div>
                                                <div> ₹ <span id="amount-right" class=""></span></div>
                                            </div>
                                        </div>
                                    </div> -->

                                    <button id="applyFiltersBtn" class="applybtn btn-primary">Apply Filters</button>
                        </ul>
                    </div>





                </div>
                <style>
                    input[type="checkbox"] {
                        /* Define your desired color */
                        accent-color: #e97730;
                    }

                    .text-left {
                        padding-left: 14px;
                        font-weight: 600;
                    }

                    .applybtn {
                        margin-left: 52px;
                        background-color: #e97730;
                        border: none;
                        padding: 10px 15px 10px;
                        margin-top: 14;

                    }

                    .applybtn:hover {
                        background-color: #b64d0c;

                    }

                    .sidebar {
                        border: 1px solid #ccc;
                        /* Add a 1px solid border with a color of #ccc */
                        padding: 10px;
                        margin-left: -126px;
                        margin-right: 40px;
                        /* Add some padding to create space between the border and content */
                    }

                    /* Style for the checkbox list */
                    .checkbox-list {
                        list-style: none;
                        padding: 0;
                    }

                    /* Style for each checkbox container */
                    .checkbox-container {
                        display: flex;
                        align-items: center;
                        margin-bottom: 10px;
                        /* Adjust spacing between each checkbox */
                    }

                    /* Style for the checkbox input */
                    .checkbox-container input[type="checkbox"] {
                        margin-right: 0px;
                    }

                    /* Style for the category label */
                    .checkbox-container label {
                        font-weight: normal;
                        width: 726px;

                    }
                </style>
                <div class="col-lg-9">
                    <div class="row flex-row-reverse">
                        <div class="col-12">
                            <div class="shop-topbar-wrapper mb-40" id="shopContent">
                                <div class="shop-topbar-left">
                                    <div class="showing-item">
                                        <% if(allItems.length>0) {%>
                                            <% const startItem=(currentPage - 1) * perPage + 1; %>
                                                <% const endItem=Math.min(currentPage * perPage, totalCount); %>
                                                    <span>Showing <%= startItem %>–<%= endItem %> of <%= totalCount %>
                                                                    results</span>
                                                    <% } else { %>
                                                        <span>No results found</span>
                                                        <% } %>

                                    </div>

                                </div>
                                <div class="shop-topbar-right">
                                    <div class="shop-sorting-area">
                                        <form action="/shop" method="GET">
                                            <select class="nice-select nice-select-style-1" name="sortBy"
                                                onchange="this.form.submit()">
                                                <option value="default" <%=sortBy==='default' ? 'selected' : '' %>
                                                    >Default Sorting</option>
                                                <option value="A-Z" <%=sortBy==='A-Z' ? 'selected' : '' %>>Sort by A-Z
                                                </option>
                                                <option value="Z-A" <%=sortBy==='Z-A' ? 'selected' : '' %>>Sort by Z-A
                                                </option>
                                                <option value="Price high to low" <%=sortBy==='Price high to low'
                                                    ? 'selected' : '' %>>Price high to low</option>
                                                <option value="Price low to high" <%=sortBy==='Price low to high'
                                                    ? 'selected' : '' %>>Price low to high</option>
                                                <option value="latest" <%=sortBy==='latest' ? 'selected' : '' %>>Sort by
                                                    latest</option>
                                            </select>
                                        </form>
                                    </div>

                                    <div class="shop-view-mode nav">
                                        <a class="active" href="#shop-1" data-bs-toggle="tab"><i
                                                class=" ti-layout-grid3 " style="line-height: 2;"></i> </a>
                                        <a href="#shop-2" data-bs-toggle="tab" class=""><i class=" ti-view-list-alt "
                                                style="line-height: 2;"></i></a>
                                    </div>
                                </div>
                            </div>
                            <div class="shop-bottom-area">
                                <div class="tab-content jump">
                                    <div id="shop-1" class="tab-pane active">
                                        <div class="row">

                                            <% allItems.forEach(product=> { %>
                                                <div class="col-lg-4 col-md-4 col-sm-6 col-12">
                                                    <div class="product-wrap mb-35" data-aos="fade-up"
                                                        data-aos-delay="200">
                                                        <div class="product-img img-zoom mb-25">
                                                            <a href="/product-details?id=<%=product._id %>">
                                                                <img src="/productAssets/<%= product.images[0] %>"
                                                                    alt="">
                                                            </a>
                                                            <!-- <div class="product-badge badge-top badge-right badge-pink">
                                                            <span>-10%</span>
                                                        </div> -->
                                                            <input type="text" value="<%=product._id%>" hidden
                                                                class="form-control" id="product" name="product">

                                                            <div class="product-action-wrap">
                                                                <button class="product-action-btn-1 add-to-wishlist-btn"
                                                                    data-product-id="<%= product._id %>"
                                                                    title="Wishlist"><i class="pe-7s-like"></i></button>
                                                                <button class="product-action-btn-1" title="Quick View"
                                                                    data-product-id="<%= product._id %>"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#exampleModal">
                                                                    <i class="pe-7s-look"></i>
                                                                </button>
                                                            </div>
                                                            <!-- Inside your EJS template -->
                                                            <div class="product-action-2-wrap">
                                                                <button class="product-action-btn-2 add-to-cart-btn"
                                                                    data-product-id="<%= product._id %>"
                                                                    title="Add To Cart">
                                                                    <i class="pe-7s-cart"></i> Add to cart
                                                                </button>
                                                            </div>

                                                        </div>
                                                        <div class="product-content">
                                                            <h3><a href="/product-details?id=<%=product._id %>">
                                                                    <%=product.productName %>
                                                                </a></h3>
                                                            <div class="product-price">
                                                                <% if(product.productOffer !==0 || product.categoryOffer
                                                                    !==0){ %>
                                                                    <span class="old-price">₹ <%=(
                                                                            product.productPrice)%></span>
                                                                    <span class="new-price">₹ <%= product.offerPrice %>
                                                                            </span>
                                                                    <% } else { %>
                                                                        <span class="old-price"></span>
                                                                        <span class="new-price">₹ <%=
                                                                                product.productPrice %></span>
                                                                        <% } %>
                                                            </div>
                                                        </div>


                                                    </div>
                                                </div>

                                                <% }); %>


                                        </div>
                                        <% if(allItems.length>0) { %>
                                            <div class="pagination-style-1" data-aos="fade-up" data-aos-delay="200">
                                                <ul>
                                                    <% for (let i=1; i <=totalPages; i++) { %>
                                                        <li><a class="<%= currentPage === i ? 'active' : '' %>"
                                                                href="/shop?page=<%= i %>&sortBy=<%= sortBy %>">
                                                                <%= i %>
                                                            </a></li>
                                                        <% } %>
                                                            <li><a class="next"
                                                                    href="/shop?page=<%= currentPage + 1 %>&sortBy=<%= sortBy %>"><i
                                                                        class="ti-angle-double-right"
                                                                        style="line-height: 2"></i></a></li>
                                                </ul>
                                            </div>
                                                <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nouislider/14.6.3/nouislider.min.js"></script>
    <script>
        document.querySelectorAll('.add-to-cart-btn').forEach(button => {
            button.addEventListener('click', function () {
                const productId = this.getAttribute('data-product-id');
                addToCart(productId);
            });
        });

        function addToCart(productId) {
            // Here you can implement your logic to add the product to the cart
            console.log('Adding product to cart:', productId);

            fetch('/add-to-cart?user=<%=userId%>', {
                method: 'POST',
                body: JSON.stringify({
                    productId: productId,
                    userId: "<%=userId%>"
                }),
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(response => {
                if (response.ok) {
                    $.toast({
                        heading: 'Success',
                        text: 'Product added to cart successfully',
                        position: 'top-center',
                        showHideTransition: 'slide',
                        icon: 'success'
                    })
                } else if (response.status === 401) {
                    $.toast({
                        heading: 'Error',
                        text: 'Maximum Quantity Per Order Reached',
                        showHideTransition: 'fade',
                        position: 'top-center',
                        icon: 'error'
                    })

                } else if (response.status === 405) {
                    $.toast({
                        heading: 'Error',
                        text: 'Insufficient stock available',
                        showHideTransition: 'fade',
                        position: 'top-center',
                        icon: 'error'
                    })
                } else {
                    $.toast({
                        heading: 'Error',
                        text: 'Error adding product to cart',
                        showHideTransition: 'fade',
                        position: 'top-center',
                        icon: 'error'
                    })

                    showToast("Error adding product to cart");
                }
            }).then(data => {
                let cartQuantity = data.cartQty;
                updateCartQuantity()
            }).catch(error => {
                console.error("Error adding product to cart:", error);
                showToast("Error adding product to cart");
                $.toast({
                    heading: 'Error',
                    text: 'Error adding product to cart',
                    showHideTransition: 'fade',
                    position: 'top-center',
                    icon: 'error'
                })
            });
        }
        let cartQuantity = 0;

        // Function to update the cart quantity element
        function updateCartQuantity() {
            document.getElementById('cartItemCount').textContent = cartQuantity;
        }
    </script>
    <script>
        document.querySelectorAll('.add-to-wishlist-btn').forEach(button => {
            button.addEventListener('click', function () {
                const productId = this.getAttribute('data-product-id');
                addToWishlist(productId);
            });
        });

        function addToWishlist(productId) {
            // Here you can implement your logic to add the product to the wishlist
            console.log('Adding product to wishlist:', productId);

            fetch('/add-to-wishlist', {
                method: 'POST',
                body: JSON.stringify({
                    productId: productId
                }),
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        $.toast({
                            heading: 'Added Successfully',
                            text: 'Product added to wishlist',
                            position: 'top-center',
                            showHideTransition: 'slide',
                            icon: 'success'
                        });
                    } else {
                        return response.json().then(data => {
                            if (data.message && data.message === "Product already exists in the wishlist") {
                                $.toast({
                                    heading: 'Failed to Add ',
                                    text: 'Product already exists in the wishlist',
                                    position: 'top-center',
                                    showHideTransition: 'slide',
                                    icon: 'error'
                                });
                            } else {
                                throw new Error('Failed to add product to wishlist');
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error("Error adding product to wishlist:", error);
                    $.toast({
                        heading: 'Error',
                        text: 'Error adding product to wishlist',
                        showHideTransition: 'fade',
                        position: 'top-center',
                        icon: 'error'
                    });
                });
        }

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', applyFilters);
            }

            // Set initial values for the price slider based on the current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const priceParam = urlParams.get('price');
            if (priceParam) {
                const [minPrice, maxPrice] = priceParam.split(',');
                document.getElementById('input-left').value = minPrice;
                document.getElementById('input-right').value = maxPrice;
                updatePriceRangeLabels(minPrice, maxPrice);
            }

            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', function (event) {
                    event.preventDefault();
                    const searchInput = document.getElementById('searchInput').value.trim();
                    const queryParams = new URLSearchParams(window.location.search);
                    queryParams.set('search', searchInput);
                    window.location.href = `/shop?page=1&sortBy=${document.querySelector('select[name="sortBy"]').value}&${queryParams}`;
                });
            }
        });

        function applyFilters() {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(checkbox => checkbox.value);
            const queryParams = new URLSearchParams(window.location.search);

            // Add search query parameter if it exists
            const searchInput = document.getElementById('searchInput').value.trim();
            if (searchInput) {
                queryParams.set('search', searchInput);
            }

            if (selectedCategories.length > 0) {
                queryParams.set('category', selectedCategories.join(','));
            } else {
                queryParams.delete('category');
            }

            // Check if the "Out Of Stock" checkbox is checked
            const outOfStockCheckbox = document.getElementById('outofstock');
            if (outOfStockCheckbox.checked) {
                queryParams.set('outOfStock', true);
            } else {
                queryParams.delete('outOfStock');
            }

            const minPrice = document.getElementById('input-left').value;
            const maxPrice = document.getElementById('input-right').value;
            queryParams.set('price', `${minPrice},${maxPrice}`);

            // Construct the new URL with the search query and applied filters
            let newUrl = `/shop?page=1&sortBy=${document.querySelector('select[name="sortBy"]').value}`;
            if (queryParams.toString()) {
                newUrl += `&${queryParams.toString()}`;
            }
            window.location.href = newUrl;
        }

    </script>

<script src="/user/js/filter.js"></script>

    <%- include('../layouts/footer.ejs') %>